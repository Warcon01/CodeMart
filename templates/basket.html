<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Shopping Cart - CodeMart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/basket.css">
</head>
<body>

<div class="d-flex flex-column min-vh-100">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex flex-grow-1"></div>
            <div class="text-center flex-grow-1">
                <a class="navbar-brand fw-bold fs-3 text-dark" href="/">CodeMart<span class="fs-5">â„¢</span></a>
            </div>
            <div class="d-flex align-items-center">
                {{if .IsLoggedIn}}
                <a class="btn btn-outline-secondary me-2" href="/profile">ðŸ‘¤ Profile</a>
                {{else}}
                <a class="btn btn-outline-secondary me-2" href="/login">ðŸ”‘ Login</a>
                {{end}}
                <a class="btn btn-outline-primary me-2" href="/basket">ðŸ›’ Cart</a>
                <a class="btn btn-warning fw-bold" href="/purchase_history">âœ… Checkout</a>
            </div>
        </div>
    </nav>

    <!-- Shopping Cart -->
    <div class="basket-container">
        <h2 class="text-center my-4">Your Basket</h2>
        <div class="basket-items" id="basket-items"></div>
        <div class="basket-total">Total: <span id="basket-total">0â‚¸</span></div>
        <button href="#" class="btn btn-primary mt-3" id="buy-now">Buy Now</button>
    </div>


    <!-- Footer -->
    <footer class="footer text-center bg-white text-dark py-3 mt-5 shadow-sm">
        <p class="mb-0">Â© 2025. Made by <b>Adi M.</b> | <b>Vladislav Z.</b> | <b>Abzal O.</b></p>
    </footer>
</div>
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        loadCart();

        // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹
        function loadCart() {
            fetch('/api/cart')
                .then(response => response.json())
                .then(data => {
                    let basketItemsDiv = document.getElementById('basket-items');
                    let basketTotal = document.getElementById('basket-total');
                    basketItemsDiv.innerHTML = "";
                    let total = 0;

                    if (data.items.length > 0) {
                        data.items.forEach(item => {
                            let itemDiv = document.createElement('div');
                            itemDiv.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                <span>${item.name} - ${item.quantity} x ${item.price}â‚¸</span>
                                <button class="remove-btn" data-productid="${item.product_id}">Remove</button>
                            </div>
                            `;
                            basketItemsDiv.appendChild(itemDiv);
                            total += item.price * item.quantity;
                        });
                    } else {
                        basketItemsDiv.innerHTML = "<p>Your basket is empty.</p>";
                    }
                    basketTotal.textContent = total + "â‚¸";
                });
        }

        // Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
        document.getElementById('basket-items').addEventListener("click", function (e) {
            if (e.target.classList.contains("remove-item")) {
                let productID = e.target.getAttribute("data-productid");
                fetch('/api/cart/delete', {
                    method: "POST",
                    body: new URLSearchParams({ product_id: productID }),
                    headers: { "Content-Type": "application/x-www-form-urlencoded" }
                }).then(() => loadCart());
            }
        });

        $(document).ready(function(){
            // Load the basket on page load
            loadCart();

            // Buy Now Button: Process order and show a thank you message.
            $('#buy-now').click(function(){
                $.post('/checkout', function(){
                    alert('Thank you for purchasing!');
                    // Optionally, reload the basket (if the order clears the cart)
                    loadCart();
                }).fail(function(xhr, textStatus, errorThrown){
                    console.error("Checkout error:", xhr.responseText);
                    alert('Checkout failed: ' + xhr.responseText);
                });
            });

            // Delegate event for Remove buttons to delete an item from the cart.
            $('#basket-items').on('click', '.remove-item', function(){
                var productID = $(this).data('productid');
                $.post('/api/cart/delete', { product_id: productID }, function(){
                    loadCart();
                }).fail(function(xhr, textStatus, errorThrown){
                    console.error("Delete error:", xhr.responseText);
                    alert('Failed to remove item: ' + xhr.responseText);
                });
            });
        });

    });
</script>

</body>
</html>
